$(function(){function M(p){var s=this;s.settings=p[0];s.sessionEarnings=ko.observable(0);s.lifetimeEarnings=ko.observable(0);s.totalJobs=ko.observable(0);s.isPrinting=ko.observable(false);s.currentFile=ko.observable("-");s.elapsedSeconds=ko.observable(0);s.recentActivity=ko.observableArray([]);s.mintStatusMessage=ko.observable(null);s._t=null;
s.elapsedFormatted=ko.computed(function(){var e=s.elapsedSeconds(),h=Math.floor(e/3600),m=Math.floor((e%3600)/60),sc=e%60;return h+":"+(m<10?"0":"")+m+":"+(sc<10?"0":"")+sc});
s.estimatedEarnings=ko.computed(function(){return s.elapsedSeconds()*0.005});
s._startTimer=function(){s._stopTimer();s.elapsedSeconds(0);s._t=setInterval(function(){s.elapsedSeconds(s.elapsedSeconds()+1)},1000)};
s._stopTimer=function(){if(s._t){clearInterval(s._t);s._t=null}};
s._fmt=function(e){var h=Math.floor(e/3600),m=Math.floor((e%3600)/60),sc=e%60;return h+":"+(m<10?"0":"")+m+":"+(sc<10?"0":"")+sc};
s.onDataUpdaterPluginMessage=function(pl,d){if(pl!=="mint")return;var m=d;switch(m.type){case"print_started":s.isPrinting(true);s.currentFile(m.data.filename);s._startTimer();break;case"job_settled":s.isPrinting(false);s._stopTimer();s.sessionEarnings(m.data.session_earnings);s.lifetimeEarnings(m.data.lifetime_earnings);s.totalJobs(m.data.total_jobs);s.recentActivity.unshift({filename:m.data.filename,durationFormatted:s._fmt(m.data.duration_seconds),reward:m.data.reward,tx_url:m.data.tx_url||""});if(s.recentActivity().length>20)s.recentActivity.pop();new PNotify({title:"MINT!",text:"~"+m.data.reward.toFixed(4)+" MINT",type:"success",hide:true,delay:8000});break;case"print_failed":case"print_cancelled":s.isPrinting(false);s._stopTimer();new PNotify({title:"MINT",text:m.data.reason,type:"info",hide:true,delay:5000});break;case"error":new PNotify({title:"MINT Error",text:m.data.message,type:"error",hide:true,delay:8000});break}};
s.registerMachine=function(){s.mintStatusMessage("Registering...");OctoPrint.simpleApiCommand("mint","register",{}).done(function(r){s.mintStatusMessage("OK: "+r.signature.substr(0,20)+"...")}).fail(function(){s.mintStatusMessage("Failed")})};
s.checkStatus=function(){s.mintStatusMessage("...");OctoPrint.simpleApiCommand("mint","status",{}).done(function(r){s.mintStatusMessage("Machine:"+(r.machine_id?r.machine_id.substr(0,12)+"...":"none")+" Jobs:"+r.total_jobs)}).fail(function(){s.mintStatusMessage("Error")})};
s.onBeforeBinding=function(){s.lifetimeEarnings(parseFloat(s.settings.settings.plugins.mint.lifetime_earnings())||0)}}
OCTOPRINT_VIEWMODELS.push({construct:M,dependencies:["settingsViewModel"],elements:["#tab_plugin_mint","#settings_plugin_mint","#navbar_plugin_mint"]})});
